{"version":3,"sources":["../../../packages/PJW/tools/browser-build.js"],"names":["fs","require","normalize","join","envify","UglifyJS","browserify","babelify","tfilter","debug","process","env","DEBUG","console","error","root","__dirname","fromRoot","subPath","licence","npm_package_version","readFileSync","minify","code","warnings","bundle","files","config","callback","map","f","Object","assign","standalone","ignoreMissing","fullPaths","paths","basedir","bundler","exclude","i","transform","include","presets","global","ENVIRONMENT","DIRNAME","err","baseCode","module","parent","argv","cmd","baseFiles","JSON","parse","slice","length","Error","stdout","write","writeFile","toolName","replace","warn","exports"],"mappings":"AAAA;;;AAEA,IAAMA,EAAE,GAAGC,OAAO,CAAC,IAAD,CAAlB;;eAC4BA,OAAO,CAAC,MAAD,C;IAA3BC,S,YAAAA,S;IAAWC,I,YAAAA,I;;AACnB,IAAMC,MAAM,GAAGH,OAAO,CAAC,eAAD,CAAtB;;AACA,IAAMI,QAAQ,GAAGJ,OAAO,CAAC,WAAD,CAAxB;;AACA,IAAMK,UAAU,GAAGL,OAAO,CAAC,YAAD,CAA1B;;AACA,IAAMM,QAAQ,GAAGN,OAAO,CAAC,UAAD,CAAxB;;AACA,IAAMO,OAAO,GAAGP,OAAO,CAAC,SAAD,CAAvB;;AAEA,SAASQ,KAAT,GAAwB;AACtB,MAAIC,OAAO,CAACC,GAAR,CAAYC,KAAhB,EAAuB;AAAA;;AACrB,gBAAAC,OAAO,EAACC,KAAR;AACD;AACF;;AAED,IAAMC,IAAI,GAAGb,SAAS,CAACC,IAAI,CAACa,SAAD,EAAY,IAAZ,CAAL,CAAtB;;AACA,SAASC,QAAT,CAAkBC,OAAlB,EAA2B;AACzB,SAAOhB,SAAS,CAACC,IAAI,CAACY,IAAD,EAAOG,OAAP,CAAL,CAAhB;AACD;;AAED,IAAMC,OAAO,GACX,SACA,OADA,GAEAT,OAAO,CAACC,GAAR,CAAYS,mBAFZ,GAGA,IAHA,GAIA,sDAJA,GAKApB,EAAE,CAACqB,YAAH,CAAgBJ,QAAQ,CAAC,eAAD,CAAxB,CALA,GAMA,IAPF,C,CASA;;AAEA,SAASK,MAAT,CAAgBC,IAAhB,EAAsB;AACpBV,EAAAA,OAAO,CAACC,KAAR,CAAc,gBAAd;AAEA,SAAOT,QAAQ,CAACiB,MAAT,CAAgBC,IAAhB,EAAsB;AAAEC,IAAAA,QAAQ,EAAE;AAAZ,GAAtB,EAA2CD,IAAlD;AACD;;AAED,SAASE,MAAT,CAAgBC,KAAhB,EAAuBC,MAAvB,EAA+BC,QAA/B,EAAyC;AACvC,MAAI,OAAOF,KAAP,KAAiB,QAArB,EAA+BA,KAAK,GAAG,CAACA,KAAD,CAAR;AAC/BA,EAAAA,KAAK,GAAGA,KAAK,CAACG,GAAN,CAAU,UAAAC,CAAC,EAAI;AACrB,WAAOA,CAAC,CAAC,CAAD,CAAD,KAAS,GAAT,GAAeA,CAAf,GAAmBb,QAAQ,CAACa,CAAD,CAAlC,CADqB,CACkB;AACxC,GAFO,CAAR;AAGAjB,EAAAA,OAAO,CAACC,KAAR,CAAc,gBAAgBY,KAAK,CAACvB,IAAN,CAAW,IAAX,CAAhB,GAAmC,KAAjD;AACAwB,EAAAA,MAAM,GAAGI,MAAM,CAACC,MAAP,CACP;AACEC,IAAAA,UAAU,EAAE,KADd;AAEEC,IAAAA,aAAa,EAAE,IAFjB;AAGEC,IAAAA,SAAS,EAAE,KAHb;AAIE1B,IAAAA,KAAK,EACH,iBAA0B,aAA1B,IACA,iBAA0B,MAN9B;AAOE2B,IAAAA,KAAK,EAAE,CAACrB,IAAD,CAPT;AAQEsB,IAAAA,OAAO,EAAEtB;AARX,GADO,EAWPY,MAXO,CAAT;AAaAlB,EAAAA,KAAK,CAAC,oBAAD,EAAuBkB,MAAvB,CAAL;AACA,MAAMW,OAAO,GAAGhC,UAAU,CAACoB,KAAD,EAAQC,MAAR,CAAV,CAA0BY,OAA1B,CACdtB,QAAQ,CAAC,oBAAD,CADM,CAAhB;AAGAU,EAAAA,MAAM,CAACY,OAAP,GAAiBZ,MAAM,CAACY,OAAP,IAAkB,EAAnC;;AACA,OAAK,IAAIT,CAAJ,EAAOU,CAAC,GAAG,CAAhB,EAAoBV,CAAC,GAAGH,MAAM,CAACY,OAAP,CAAeC,CAAf,CAAxB,EAA4CA,CAAC,EAA7C,EAAiD;AAC/CF,IAAAA,OAAO,CAACC,OAAR,CAAgBtB,QAAQ,CAACa,CAAD,CAAxB;AACD;;AAEDQ,EAAAA,OAAO,CACJG,SADH,CACalC,QADb,EAEGkC,SAFH,CAGIjC,OAAO,CAACD,QAAD,EAAW;AAAEmC,IAAAA,OAAO,EAAE;AAAX,GAAX,CAHX,EAII;AAAEC,IAAAA,OAAO,EAAE,CAAC,YAAD,CAAX;AAA2BC,IAAAA,MAAM,EAAE;AAAnC,GAJJ,EAMGH,SANH,CAMarC,MAAM,CAAC;AAAEyC,IAAAA,WAAW,EAAE,SAAf;AAA0BC,IAAAA,OAAO,EAAE;AAAnC,GAAD,CANnB,EAM0E;AACtEF,IAAAA,MAAM,EAAE;AAD8D,GAN1E,EASGnB,MATH,CASU,UAACsB,GAAD,EAAMC,QAAN,EAAmB;AACzB,QAAID,GAAJ,EAAS,OAAOnB,QAAQ,CAACmB,GAAD,CAAf;AAETnB,IAAAA,QAAQ,CACN,IADM,EAEN,kDACE,sDADF,GAEEoB,QAJI,CAAR;AAMD,GAlBH;AAmBD;;AAED,IAAI,CAACC,MAAM,CAACC,MAAZ,EAAoB;AAClB,MAAIvB,MAAM,GAAGjB,OAAO,CAACyC,IAAR,CAAa,CAAb,CAAb;AACA,MAAMC,GAAG,GAAG1C,OAAO,CAACyC,IAAR,CAAa,CAAb,KAAmB,YAA/B;;AAEA,UAAQC,GAAR;AACE,SAAK,MAAL;AAAa;AACX,YAAIC,SAAJ;;AACA,YAAI1B,MAAM,CAAC,CAAD,CAAN,KAAc,GAAlB,EAAuB;AACrBA,UAAAA,MAAM,GAAG2B,IAAI,CAACC,KAAL,CAAW5B,MAAX,CAAT;AACA0B,UAAAA,SAAS,GAAG3C,OAAO,CAACyC,IAAR,CAAaK,KAAb,CAAmB,CAAnB,CAAZ;AACD,SAHD,MAGO;AACL7B,UAAAA,MAAM,GAAG,EAAT;AACA0B,UAAAA,SAAS,GAAG3C,OAAO,CAACyC,IAAR,CAAaK,KAAb,CAAmB,CAAnB,CAAZ;AACD;;AAED,YAAIH,SAAS,CAACI,MAAV,KAAqB,CAAzB,EAA4B,MAAM,IAAIC,KAAJ,CAAU,gBAAV,CAAN;AAC5BjC,QAAAA,MAAM,CAAC4B,SAAD,EAAY1B,MAAZ,EAAoB,UAACoB,GAAD,EAAMxB,IAAN,EAAe;AACvC,cAAIwB,GAAJ,EAAS,MAAMA,GAAN;AACTrC,UAAAA,OAAO,CAACiD,MAAR,CAAeC,KAAf,CAAqBrC,IAArB;AACAV,UAAAA,OAAO,CAACC,KAAR,CAAc,OAAd;AACD,SAJK,CAAN;AAKA;AACD;;AAED,SAAK,YAAL;AACE,UAAIa,MAAJ,EAAYA,MAAM,GAAG2B,IAAI,CAACC,KAAL,CAAW5B,MAAX,CAAT,CAAZ,KACKA,MAAM,GAAG,EAAT;AACLF,MAAAA,MAAM,CAAC,cAAD,EAAiBE,MAAjB,EAAyB,UAACoB,GAAD,EAAMxB,IAAN,EAAe;AAC5C,YAAIwB,GAAJ,EAAS,MAAMA,GAAN;AACT/C,QAAAA,EAAE,CAAC6D,SAAH,CACE5C,QAAQ,CAAC,oBAAD,CADV,EAEEE,OAAO,GAAG,IAAV,GAAiBI,IAFnB,EAGE,UAAAwB,GAAG,EAAI;AACL,cAAIA,GAAJ,EAAS,MAAMA,GAAN;AACTlC,UAAAA,OAAO,CAACC,KAAR,CAAc,2BAAd;AACD,SANH;AAQAd,QAAAA,EAAE,CAAC6D,SAAH,CACE5C,QAAQ,CAAC,wBAAD,CADV,EAEEE,OAAO,GAAG,IAAV,GAAiBG,MAAM,CAACC,IAAD,CAFzB,EAGE,UAAAwB,GAAG,EAAI;AACL,cAAIA,GAAJ,EAAS,MAAMA,GAAN;AACTlC,UAAAA,OAAO,CAACC,KAAR,CAAc,+BAAd;AACD,SANH;AAQD,OAlBK,CAAN;AAmBA;;AAEF,SAAK,MAAL;AAAa;AACX,YAAMgD,QAAQ,GAAGpD,OAAO,CAACyC,IAAR,CAAa,CAAb,EAAgBY,OAAhB,CAAwBhD,IAAxB,EAA8B,IAA9B,EAAoCgD,OAApC,CAA4C,MAA5C,EAAoD,GAApD,CAAjB;AACAlD,QAAAA,OAAO,CAACmD,IAAR,CACE,CACE,uDADF,EAEE,EAFF,EAGE,QAHF,gBAISF,QAJT,8BAKE,EALF,EAME,oBANF,EAOE,oBAPF,EAQE,EARF,EASE,8CATF,EAUE,QAVF,gBAWSA,QAXT,kDAYE,UAZF,gBAaSA,QAbT,kDAcE,EAdF,EAeE,cAfF,EAgBE,cAhBF,EAiBE,EAjBF,EAkBE,gDAlBF,EAmBE,QAnBF,gBAoBSA,QApBT,kEAqBE,UArBF,gBAsBSA,QAtBT,4DAuBE,EAvBF,EAwBE,wDAxBF,EAyBE3D,IAzBF,CAyBO,IAzBP,CADF;AA4BA;AACD;;AAED;AACE,YAAM,IAAIuD,KAAJ,0CAEFhD,OAAO,CAACyC,IAAR,CAAa,CAAb,CAFE,kCAAN;AA9EJ;AAoFD;;AAEDF,MAAM,CAACgB,OAAP,GAAiB;AAAExC,EAAAA,MAAM,EAANA;AAAF,CAAjB","sourcesContent":["#!/usr/bin/env node\n\nconst fs = require('fs');\nconst { normalize, join } = require('path');\nconst envify = require('envify/custom');\nconst UglifyJS = require('uglify-js');\nconst browserify = require('browserify');\nconst babelify = require('babelify');\nconst tfilter = require('tfilter');\n\nfunction debug(...args) {\n  if (process.env.DEBUG) {\n    console.error(...args);\n  }\n}\n\nconst root = normalize(join(__dirname, '..'));\nfunction fromRoot(subPath) {\n  return normalize(join(root, subPath));\n}\n\nconst licence =\n  '/*\\n' +\n  'PJW v' +\n  process.env.npm_package_version +\n  '\\n' +\n  'https://github.com/hellokellyworld/purejswatermark\\n' +\n  fs.readFileSync(fromRoot('../../LICENSE')) +\n  '*/';\n\n// Browserify and Babelize.\n\nfunction minify(code) {\n  console.error('Compressing...');\n\n  return UglifyJS.minify(code, { warnings: false }).code;\n}\n\nfunction bundle(files, config, callback) {\n  if (typeof files === 'string') files = [files];\n  files = files.map(f => {\n    return f[0] === '/' ? f : fromRoot(f); // ensure path.\n  });\n  console.error('Browserify ' + files.join(', ') + '...');\n  config = Object.assign(\n    {\n      standalone: 'PJW',\n      ignoreMissing: true,\n      fullPaths: false,\n      debug:\n        process.env.BABEL_ENV === 'development' ||\n        process.env.BABEL_ENV === 'test',\n      paths: [root],\n      basedir: root\n    },\n    config\n  );\n  debug('browserify config:', config);\n  const bundler = browserify(files, config).exclude(\n    fromRoot('browser/lib/PJW.js')\n  );\n  config.exclude = config.exclude || [];\n  for (let f, i = 0; (f = config.exclude[i]); i++) {\n    bundler.exclude(fromRoot(f));\n  }\n\n  bundler\n    .transform(babelify)\n    .transform(\n      tfilter(babelify, { include: '**/node_modules/file-type/*.js' }),\n      { presets: ['@babel/env'], global: true }\n    )\n    .transform(envify({ ENVIRONMENT: 'BROWSER', DIRNAME: 'browser/lib/' }), {\n      global: true\n    })\n    .bundle((err, baseCode) => {\n      if (err) return callback(err);\n\n      callback(\n        null,\n        \"if ((typeof(window)=='undefined' || !window) \" +\n          \"&& (typeof(self)!='undefined')) var window = self;\\n\" +\n          baseCode\n      );\n    });\n}\n\nif (!module.parent) {\n  let config = process.argv[3];\n  const cmd = process.argv[2] || 'prepublish';\n\n  switch (cmd) {\n    case 'test': {\n      let baseFiles;\n      if (config[0] === '{') {\n        config = JSON.parse(config);\n        baseFiles = process.argv.slice(4);\n      } else {\n        config = {};\n        baseFiles = process.argv.slice(3);\n      }\n\n      if (baseFiles.length === 0) throw new Error('No file given.');\n      bundle(baseFiles, config, (err, code) => {\n        if (err) throw err;\n        process.stdout.write(code);\n        console.error('Done.');\n      });\n      break;\n    }\n\n    case 'prepublish':\n      if (config) config = JSON.parse(config);\n      else config = {};\n      bundle('src/index.js', config, (err, code) => {\n        if (err) throw err;\n        fs.writeFile(\n          fromRoot('browser/lib/PJW.js'),\n          licence + '\\n' + code,\n          err => {\n            if (err) throw err;\n            console.error('browserifyed PJW.js done.');\n          }\n        );\n        fs.writeFile(\n          fromRoot('browser/lib/PJW.min.js'),\n          licence + '\\n' + minify(code),\n          err => {\n            if (err) throw err;\n            console.error('browserifyed PJW.min.js done.');\n          }\n        );\n      });\n      break;\n\n    case 'help': {\n      const toolName = process.argv[1].replace(root, './').replace(/\\/+/g, '/');\n      console.warn(\n        [\n          'Build PJW or its modules for the browser environment.',\n          '',\n          'Usage:',\n          `  $ ${toolName} <command> [parameters]`,\n          '',\n          'Prepublish Command',\n          '==================',\n          '',\n          'Builds PJW and updates \"browser/lib/PJW.js\".',\n          'Usage:',\n          `  $ ${toolName} prepublish [JSON browserify configuration]`,\n          'Example:',\n          `  $ ${toolName} prepublish '{\"basedir\":\"/other/path\"}'`,\n          '',\n          'Test Command',\n          '============',\n          '',\n          'Builds a list of modules and output to STDOUT.',\n          'Usage:',\n          `  $ ${toolName} test [JSON browserify configuration] [file1 [file2 [...]]]`,\n          'Example:',\n          `  $ ${toolName} test '{\"exclude\":[\"index.js\"]}' test/jgd.test.js`,\n          '',\n          'Set DEBUG env var to know the resulting configuration.'\n        ].join('\\n')\n      );\n      break;\n    }\n\n    default:\n      throw new Error(\n        `Unknown command given. Run \"$ ${\n          process.argv[1]\n        } help\" for more information`\n      );\n  }\n}\n\nmodule.exports = { bundle };\n"],"file":"browser-build.js"}